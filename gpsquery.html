<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS åœ°ç†å®šä½è³‡è¨Šé¡¯ç¤ºèˆ‡å°èˆª</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦ç¢ºä¿æ•´å€‹é é¢çš„èƒŒæ™¯å’Œæ–‡å­—æ¨£å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* æ·ºè—ç°è‰²èƒŒæ™¯ */
            color: #1f2937; /* æ·±ç°è‰²æ–‡å­— */
        }
        /* å¡ç‰‡æ¨£å¼ */
        .info-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }
        .info-card:hover {
            transform: translateY(-2px);
        }
        /* æŒ‰éˆ•æ¨£å¼ */
        .action-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover {
            box-shadow: 0 6px 8px -2px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        /* Modal é®ç½©å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* ç¾…ç›¤ç®­é ­å®¹å™¨ */
        #compass-container {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #3b82f6;
            border-radius: 50%;
            margin: 0 auto;
            position: relative;
        }
        /* ç¾…ç›¤ç®­é ­æœ¬èº« */
        #direction-arrow {
            transition: transform 0.3s ease-out;
            transform: rotate(0deg); /* åˆå§‹ç‹€æ…‹ */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- åˆå§‹æ¬Šé™è«‹æ±‚ Modal -->
    <div id="permissionModal" class="modal-overlay">
        <div class="bg-white p-8 rounded-2xl max-w-sm mx-4 text-center shadow-2xl">
            <svg class="w-12 h-12 mx-auto text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <h2 class="text-2xl font-bold mb-3 text-gray-800">éœ€è¦æ‚¨çš„ä½ç½®è³‡è¨Š</h2>
            <p class="text-gray-600 mb-6">
                æœ¬å·¥å…·å°‡è«‹æ±‚æ‚¨çš„åœ°ç†å®šä½æ¬Šé™ï¼Œä»¥ä¾¿é¡¯ç¤ºæ‰€æœ‰ GPS æ•¸æ“šä¸¦åŸ·è¡Œå°èˆªè¨ˆç®—ã€‚
            </p>
            <button id="modalStartButton" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full w-full">
                æˆ‘åŒæ„ä¸¦å•Ÿå‹•åµæ¸¬
            </button>
        </div>
    </div>


    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">åœ°ç†å®šä½è³‡è¨Šåµæ¸¬å™¨</h1>
            <p class="text-gray-500">å®šä½ã€æ¨“å±¤ä¼°ç®—èˆ‡å°èˆªè¿½è¹¤</p>
        </header>

        <!-- æ§åˆ¶å€å¡Š -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center">
            <div id="status-message" class="font-semibold text-lg text-gray-700 mb-4 sm:mb-0">
                ç‹€æ…‹: å°šæœªé–‹å§‹åµæ¸¬
            </div>
            <div class="flex space-x-4">
                <button id="startButton" class="action-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full opacity-50 cursor-not-allowed" disabled>
                    é‡æ–°å•Ÿå‹•
                </button>
                <button id="stopButton" class="action-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full opacity-50 cursor-not-allowed" disabled>
                    åœæ­¢åµæ¸¬
                </button>
            </div>
        </div>

        <!-- éŒ¯èª¤èˆ‡è¨Šæ¯é¡¯ç¤º -->
        <div id="messageBox" class="hidden mb-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
            <!-- éŒ¯èª¤æˆ–æç¤ºè¨Šæ¯å°‡é¡¯ç¤ºåœ¨æ­¤è™• -->
        </div>

        <!-- æ–°å¢: ç›®å‰åœ°å€å€å¡Š -->
        <div class="info-card bg-yellow-50 border border-yellow-300 mb-6">
            <h2 class="text-2xl font-bold text-yellow-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h4"></path></svg>
                ç›®å‰åœ°å€ (é€†å‘åœ°ç†ç·¨ç¢¼)
            </h2>
            <p id="currentAddress" class="text-xl font-semibold text-gray-800 break-words">
                ç­‰å¾… GPS æ•¸æ“š...
            </p>
            <div id="addressSourceContainer" class="mt-2 text-xs text-gray-500 flex items-center hidden">
                <p>è³‡æ–™ä¾†æº:</p>
                <ul id="addressSources" class="list-none ml-2"></ul>
            </div>
        </div>
        
        <!-- æ•¸æ“šé¡¯ç¤ºå€å¡Š -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- å°èˆªèˆ‡å·®ç•°åˆ†æå€å¡Š -->
            <div class="info-card bg-indigo-50 border border-indigo-300">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2m4-2v8m-4 0v8m-4-8v8m0 0h12"></path></svg>
                    å°èˆªè¿½è¹¤èˆ‡å·®ç•°åˆ†æ
                </h2>

                <div class="grid grid-cols-2 gap-4 items-center mb-4">
                    <!-- ç¾…ç›¤æŒ‡æ¨™ -->
                    <div class="text-center">
                         <div id="compass-container" class="mb-2">
                             <!-- SVG ç®­é ­ (åŒ—æ¥µæœä¸Š) -->
                            <svg id="direction-arrow" class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l4.472-1.49a1 1 0 00.686-.184L10 14.265l5.053 1.066a1 1 0 001.168-1.409l-7-14z"/>
                            </svg>
                         </div>
                        <p class="text-sm text-gray-500">ç®­é ­æŒ‡å‘åƒè€ƒé»</p>
                    </div>

                    <!-- å·®ç•°æ•¸æ“š -->
                    <div class="space-y-2 text-base">
                        <p class="font-bold text-gray-800">è·é›¢: <span id="distance" class="text-indigo-600">N/A</span></p>
                        <p class="font-bold text-gray-800">æµ·æ‹”å·®: <span id="altitudeDiff" class="text-indigo-600">N/A</span></p>
                        <p class="text-sm text-gray-500">åƒè€ƒé»: <span id="refLatLon" class="font-mono text-xs">æœªè¨­å®š</span></p>
                    </div>
                </div>

                <button id="markButton" class="action-button bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Mark ç›®å‰ä½ç½®ç‚ºå°èˆªåƒè€ƒé»
                </button>
            </div>


            <!-- æµ·æ‹”é«˜åº¦èˆ‡æ¨“å±¤ä¼°ç®— -->
            <div class="info-card bg-purple-50 border border-purple-300">
                <h2 class="text-2xl font-bold text-purple-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h-2.586a1 1 0 01-.707-.293l-4.586-4.586a1 1 0 00-1.414 0l-4.586 4.586A1 1 0 017.586 21H5m14 0h-2m-8 0h-2"></path></svg>
                    é«˜åº¦èˆ‡æ¨“å±¤
                </h2>
                
                <p>æµ·æ‹”é«˜åº¦ (Alt.): <span id="altitude" class="font-mono text-gray-800">N/A</span></p>
                <p class="text-sm text-gray-500 mb-3">æµ·æ‹”ç²¾ç¢ºåº¦: <span id="altitudeAccuracy">N/A</span></p>

                <p class="text-lg text-gray-600">ä¼°ç®—ç›®å‰æ¨“å±¤ï¼š</p>
                <p id="estimatedFloor" class="text-4xl font-extrabold text-red-500 mt-1 mb-3">N/A</p>
                
                <p class="text-sm text-gray-600 mb-1">ä¸€æ¨“åŸºæº–æµ·æ‹”: <span id="groundAltitude" class="font-bold text-purple-800">æœªè¨­å®š</span></p>
                <button id="calibrateButton" class="action-button bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 text-sm rounded-lg w-full disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    è¨­å®šç›®å‰æµ·æ‹”ç‚ºåŸºæº–é» (ä¸€æ¨“)
                </button>
            </div>
            
             <!-- ç¶“ç·¯åº¦èˆ‡ç²¾ç¢ºåº¦ (æ ¸å¿ƒè³‡è¨Š) -->
            <div class="info-card md:col-span-2">
                <h2 class="text-2xl font-bold text-blue-500 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    æ ¸å¿ƒä½ç½®èˆ‡æ™‚é–“
                </h2>
                <div class="space-y-3 text-lg">
                    <p>ç·¯åº¦ (Lat): <span id="lat" class="font-mono text-gray-800">N/A</span></p>
                    <p>ç¶“åº¦ (Lon): <span id="lon" class="font-mono text-gray-800">N/A</span></p>
                    <p>ç²¾ç¢ºåº¦ (Acc.): <span id="accuracy" class="font-mono text-gray-800">N/A</span></p>
                    <p>æ›´æ–°æ™‚é–“: <span id="timestamp" class="font-mono text-gray-800 text-sm">N/A</span></p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // DOM å…ƒç´ åƒè€ƒ
        const statusMessage = document.getElementById('status-message');
        const messageBox = document.getElementById('messageBox');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const permissionModal = document.getElementById('permissionModal');
        const modalStartButton = document.getElementById('modalStartButton');
        const calibrateButton = document.getElementById('calibrateButton');
        const markButton = document.getElementById('markButton');
        const directionArrow = document.getElementById('direction-arrow');
        
        const groundAltitudeDisplay = document.getElementById('groundAltitude');
        const estimatedFloorDisplay = document.getElementById('estimatedFloor');
        const distanceDisplay = document.getElementById('distance');
        const altitudeDiffDisplay = document.getElementById('altitudeDiff');
        const refLatLonDisplay = document.getElementById('refLatLon');
        const currentAddressDisplay = document.getElementById('currentAddress');
        const addressSourcesContainer = document.getElementById('addressSourceContainer');
        const addressSourcesList = document.getElementById('addressSources');


        const dataElements = {
            lat: document.getElementById('lat'),
            lon: document.getElementById('lon'),
            accuracy: document.getElementById('accuracy'),
            altitude: document.getElementById('altitude'),
            altitudeAccuracy: document.getElementById('altitudeAccuracy'),
            timestamp: document.getElementById('timestamp'),
        };

        let watchId = null; 
        let currentAltitude = null; // å„²å­˜æœ€æ–°çš„æµ·æ‹”æ•¸æ“š
        let currentLatitude = null; 
        let currentLongitude = null; 
        let groundReferenceAltitude = null; // å„²å­˜ä½¿ç”¨è€…æ ¡æº–çš„åŸºæº–æµ·æ‹” (ç”¨æ–¼æ¨“å±¤)
        let referenceLocation = { lat: null, lon: null, alt: null }; // å„²å­˜å°èˆªåƒè€ƒé»
        
        const FLOOR_HEIGHT_METER = 3.0; // å‡è¨­æ¯å±¤æ¨“é«˜ 3 å…¬å°º
        const EARTH_RADIUS_METER = 6371000; // åœ°çƒåŠå¾‘ (å…¬å°º)
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; // Canvas å°‡è‡ªå‹•æä¾› API Key

        // å®šä½é¸é …
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 60000
        };

        // --- Utility Functions ---

        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // æ ¼å¼åŒ–æ•¸å­—ä¸¦è™•ç† null/NaN
        function formatValue(value, unit = '', fixed = 4) {
            if (value === null || typeof value === 'undefined' || isNaN(value)) {
                return 'N/A';
            }
            if (unit === 'timestamp') {
                return new Date(value).toLocaleTimeString('zh-Hant', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            }
            return `${value.toFixed(fixed)} ${unit}`;
        }
        
        // é¡¯ç¤ºè¨Šæ¯åˆ°è¨Šæ¯æ¡†
        function showMessage(type, message) {
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-yellow-100', 'border-red-400', 'border-yellow-400', 'text-red-700', 'text-yellow-700');
            messageBox.textContent = message;

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
            } else {
                 messageBox.classList.add('hidden');
            }
        }

        // æ›´æ–° UI ç‹€æ…‹ç‚ºå·²å•Ÿå‹•
        function setRunningState() {
            startButton.disabled = true;
            startButton.classList.add('opacity-50', 'cursor-not-allowed');
            stopButton.disabled = false;
            stopButton.classList.remove('opacity-50', 'cursor-not-allowed');
            calibrateButton.disabled = false;
            calibrateButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            markButton.disabled = false;
            markButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
        }

        // æ›´æ–° UI ç‹€æ…‹ç‚ºå·²åœæ­¢
        function setStoppedState() {
            startButton.disabled = false;
            startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            stopButton.disabled = true;
            stopButton.classList.add('opacity-50', 'cursor-not-allowed');
            calibrateButton.disabled = true;
            calibrateButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            markButton.disabled = true;
            markButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearData() {
            Object.values(dataElements).forEach(el => el.textContent = 'N/A');
            estimatedFloorDisplay.textContent = 'N/A';
            distanceDisplay.textContent = 'N/A';
            altitudeDiffDisplay.textContent = 'N/A';
            directionArrow.style.transform = 'rotate(0deg)'; // é‡ç½®ç®­é ­
            currentAddressDisplay.textContent = 'ç­‰å¾… GPS æ•¸æ“š...';
            addressSourcesContainer.classList.add('hidden');
            addressSourcesList.innerHTML = '';

            currentAltitude = null;
            currentLatitude = null;
            currentLongitude = null;
        }

        // --- Floor Calculation ---

        function calculateFloor() {
            if (currentAltitude === null || groundReferenceAltitude === null) {
                estimatedFloorDisplay.textContent = 'N/A';
                return;
            }

            const relativeHeight = currentAltitude - groundReferenceAltitude;

            if (relativeHeight < 0) {
                // åœ°ä¸‹å®¤
                const floorBelowGround = Math.ceil(Math.abs(relativeHeight) / FLOOR_HEIGHT_METER);
                estimatedFloorDisplay.textContent = `B${floorBelowGround}`;
            } else {
                // åœ°ä¸Šæ¨“å±¤ (1F = 0m)
                const floorAboveGround = Math.floor(relativeHeight / FLOOR_HEIGHT_METER) + 1;
                estimatedFloorDisplay.textContent = floorAboveGround.toString();
            }
        }
        
        // --- Navigation Calculation (Haversine & Bearing) ---
        
        function calculateDistanceAndBearing(lat1, lon1, lat2, lon2) {
            const Ï†1 = toRadians(lat1);
            const Ï†2 = toRadians(lat2);
            const Î”Ï† = toRadians(lat2 - lat1);
            const Î”Î» = toRadians(lon2 - lon1);

            // Haversine formula for distance
            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = EARTH_RADIUS_METER * c; // è·é›¢ï¼Œå–®ä½ï¼šå…¬å°º

            // Bearing formula for direction
            const y = Math.sin(Î”Î») * Math.cos(Ï†2);
            const x = Math.cos(Ï†1) * Math.sin(Ï†2) - 
                      Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
            let bearing = Math.atan2(y, x);
            bearing = bearing * (180 / Math.PI); // è½‰æ›ç‚ºåº¦
            bearing = (bearing + 360) % 360; // ç¢ºä¿åœ¨ 0 åˆ° 360 åº¦ä¹‹é–“

            return { distance, bearing };
        }
        
        function updateNavigation() {
            if (referenceLocation.lat === null || currentLatitude === null) {
                distanceDisplay.textContent = 'N/A';
                altitudeDiffDisplay.textContent = 'N/A';
                directionArrow.style.transform = 'rotate(0deg)';
                return;
            }

            const { distance, bearing } = calculateDistanceAndBearing(
                currentLatitude, currentLongitude, 
                referenceLocation.lat, referenceLocation.lon
            );
            
            // é¡¯ç¤ºè·é›¢
            if (distance > 1000) {
                distanceDisplay.textContent = formatValue(distance / 1000, 'km', 2);
            } else {
                 distanceDisplay.textContent = formatValue(distance, 'm', 2);
            }

            // é¡¯ç¤ºé«˜åº¦å·®ç•°
            if (currentAltitude !== null && referenceLocation.alt !== null) {
                const diff = currentAltitude - referenceLocation.alt;
                altitudeDiffDisplay.textContent = formatValue(diff, 'm', 2);
            } else {
                 altitudeDiffDisplay.textContent = 'N/A';
            }
            
            // æ›´æ–°ç¾…ç›¤ç®­é ­
            directionArrow.style.transform = `rotate(${bearing}deg)`;
            directionArrow.style.transition = distance < 1 ? 'none' : 'transform 0.3s ease-out';
        }

        // --- Address Fetching (Reverse Geocoding) ---
        
        async function fetchAddress(lat, lon) {
            currentAddressDisplay.textContent = 'æ­£åœ¨æŸ¥è©¢åœ°å€...';
            addressSourcesContainer.classList.add('hidden');
            addressSourcesList.innerHTML = '';
            
            const userQuery = `What is the full street address for GPS coordinates: latitude ${lat}, longitude ${lon}? Please answer in Traditional Chinese only with the address.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are a reverse geocoding assistant. Your task is to use the provided latitude and longitude to find and state the single best corresponding street address using Google Search. Only output the address string in Traditional Chinese." }]
                },
            };

            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(GEMINI_API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text.trim();
                        currentAddressDisplay.textContent = text || 'ç„¡æ³•è§£æåœ°å€ã€‚';

                        // æå–ä¸¦é¡¯ç¤ºä¾†æº
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            addressSourcesContainer.classList.remove('hidden');
                            addressSourcesList.innerHTML = groundingMetadata.groundingAttributions
                                .map(attribution => 
                                    attribution.web?.uri ? 
                                    `<li><a href="${attribution.web.uri}" target="_blank" class="text-blue-500 hover:underline">${attribution.web.title || 'ä¾†æºé€£çµ'}</a></li>` 
                                    : ''
                                )
                                .join('');
                            if (addressSourcesList.innerHTML === '') {
                                addressSourcesContainer.classList.add('hidden');
                            }
                        } else {
                            addressSourcesContainer.classList.add('hidden');
                        }
                        return; // æˆåŠŸï¼Œé€€å‡ºå¾ªç’°
                    } else {
                        throw new Error('API Response missing generated text.');
                    }

                } catch (e) {
                    currentRetry++;
                    if (currentRetry >= maxRetries) {
                        currentAddressDisplay.textContent = `åœ°å€æŸ¥è©¢å¤±æ•— (éŒ¯èª¤: ${e.message})ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚`;
                        console.error('API call failed after max retries:', e);
                        return;
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, currentRetry) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- Core Logic ---

        // æˆåŠŸå–å¾—ä½ç½®æ™‚çš„å›èª¿å‡½æ•¸
        function success(position) {
            // éš±è—åˆå§‹ Modal (å¦‚æœå®ƒé‚„åœ¨)
            permissionModal.classList.add('hidden');
            setRunningState();

            const coords = position.coords;
            
            // æ›´æ–°æœ€æ–°å®šä½æ•¸æ“š
            currentAltitude = coords.altitude; 
            currentLatitude = coords.latitude;
            currentLongitude = coords.longitude;

            // æ›´æ–°æ‰€æœ‰æ•¸æ“šæ¬„ä½
            dataElements.lat.textContent = formatValue(currentLatitude, 'Â°', 6);
            dataElements.lon.textContent = formatValue(currentLongitude, 'Â°', 6);
            dataElements.accuracy.textContent = formatValue(coords.accuracy, 'm');
            dataElements.altitude.textContent = formatValue(currentAltitude, 'm', 2);
            dataElements.altitudeAccuracy.textContent = formatValue(coords.altitudeAccuracy, 'm', 2);
            dataElements.timestamp.textContent = formatValue(position.timestamp, 'timestamp');
            
            // æ¯æ¬¡æˆåŠŸå®šä½å¾Œéƒ½é‡æ–°è¨ˆç®—æ¨“å±¤å’Œå°èˆª
            calculateFloor();
            updateNavigation();
            
            // å‘¼å«åœ°å€æŸ¥è©¢ (åªåœ¨ç¶“ç·¯åº¦é¦–æ¬¡å–å¾—æ™‚æˆ–æœ‰é¡¯è‘—ç§»å‹•æ™‚æ‰å‘¼å«ï¼Œä½†ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡æ¯æ¬¡éƒ½å‘¼å«)
            fetchAddress(currentLatitude, currentLongitude);

            statusMessage.textContent = 'ç‹€æ…‹: åµæ¸¬ä¸­ (æ•¸æ“šå·²æ›´æ–°)';
            messageBox.classList.add('hidden');
        }

        // å–å¾—ä½ç½®å¤±æ•—æ™‚çš„å›èª¿å‡½æ•¸
        function error(err) {
            setStoppedState();
            clearData();
            // éš±è—åˆå§‹ Modal (å¦‚æœå®ƒé‚„åœ¨)
            permissionModal.classList.add('hidden');

            let errorMessage = '';
            
            if (err.code === 1) {
                // Permission Denied (ä½¿ç”¨è€…æ‹’çµ•)
                errorMessage = 'ğŸ“ éŒ¯èª¤ï¼šæ‚¨å·²æ‹’çµ•ä½ç½®æ¬Šé™ã€‚ç”±æ–¼éš±ç§æ”¿ç­–ï¼Œç¶²é ç„¡æ³•å†æ¬¡è‡ªå‹•è«‹æ±‚ã€‚';
                errorMessage += 'è«‹æ‰‹å‹•è‡³ iOS/Safari è¨­å®šä¸­é–‹å•Ÿï¼š';
                errorMessage += 'ã€Œè¨­å®šã€>ã€Œéš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ã€>ã€Œå®šä½æœå‹™ã€> æ‰¾åˆ°æ‚¨çš„ç€è¦½å™¨ (Safari) > å…è¨±å­˜å–ä½ç½®ã€‚';
                statusMessage.textContent = 'ç‹€æ…‹: æ¬Šé™ä¸è¶³ï¼Œå·²åœæ­¢åµæ¸¬';
            } else if (err.code === 2) {
                errorMessage = 'éŒ¯èª¤ï¼šç„¡æ³•å–å¾—ä½ç½®ã€‚è«‹æª¢æŸ¥æ‚¨çš„ GPS æˆ–ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚';
                statusMessage.textContent = 'ç‹€æ…‹: ç„¡æ³•å–å¾—ä½ç½®';
            } else if (err.code === 3) {
                errorMessage = 'éŒ¯èª¤ï¼šå®šä½è«‹æ±‚è¶…æ™‚ (Timeout)ã€‚å¯èƒ½æ˜¯è¨Šè™Ÿä¸ä½³æˆ–å®¤å…§ç’°å¢ƒå°è‡´ã€‚';
                statusMessage.textContent = 'ç‹€æ…‹: å®šä½è¶…æ™‚';
            } else {
                errorMessage = `ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: ${err.message}`;
                statusMessage.textContent = 'ç‹€æ…‹: åµæ¸¬å¤±æ•—';
            }
            
            showMessage('error', errorMessage);
        }

        // é–‹å§‹åµæ¸¬åŠŸèƒ½
        function startGeolocation() {
            if (!navigator.geolocation) {
                showMessage('error', 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Geolocation APIã€‚');
                return;
            }

            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }

            watchId = navigator.geolocation.watchPosition(success, error, geoOptions);
            statusMessage.textContent = 'ç‹€æ…‹: æ­£åœ¨ç­‰å¾…ä½ç½®è³‡è¨Š...';
            
            showMessage('warning', 'æç¤ºï¼šåˆæ¬¡å•Ÿå‹•å¯èƒ½éœ€è¦å¹¾ç§’é˜ç­‰å¾… GPS å®šä½ã€‚è«‹ç¢ºä¿å®šä½æœå‹™å·²é–‹å•Ÿã€‚');
        }

        // åœæ­¢åµæ¸¬åŠŸèƒ½
        function stopGeolocation() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                statusMessage.textContent = 'ç‹€æ…‹: åµæ¸¬å·²åœæ­¢';
                showMessage('warning', 'åµæ¸¬å·²åœæ­¢ã€‚é»æ“Šã€Œé‡æ–°å•Ÿå‹•ã€é‡æ–°é–‹å§‹ã€‚');
                setStoppedState();
                clearData();
            }
        }
        
        // æ ¡æº–åŸºæº–æµ·æ‹” (ç”¨æ–¼æ¨“å±¤ä¼°ç®—)
        function calibrateGroundAltitude() {
            if (currentAltitude === null || isNaN(currentAltitude)) {
                showMessage('error', 'éŒ¯èª¤: å°šæœªå–å¾—æœ‰æ•ˆçš„æµ·æ‹”é«˜åº¦ï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }
            
            groundReferenceAltitude = currentAltitude;
            groundAltitudeDisplay.textContent = formatValue(groundReferenceAltitude, 'm', 2);
            showMessage('warning', `âœ… æˆåŠŸè¨­å®šæ¨“å±¤åŸºæº–æµ·æ‹”: ${formatValue(groundReferenceAltitude, 'm', 2)}ã€‚`);
            
            calculateFloor();
        }
        
        // è¨­å®šåƒè€ƒé» (ç”¨æ–¼å°èˆª)
        function markReferenceLocation() {
            if (currentLatitude === null || currentLongitude === null) {
                 showMessage('error', 'éŒ¯èª¤: å°šæœªå–å¾—æœ‰æ•ˆçš„ GPS åº§æ¨™ï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            referenceLocation = {
                lat: currentLatitude,
                lon: currentLongitude,
                alt: currentAltitude 
            };

            refLatLonDisplay.textContent = `${formatValue(referenceLocation.lat, 'Â°', 4)} / ${formatValue(referenceLocation.lon, 'Â°', 4)}`;
            showMessage('warning', 'ğŸ¯ å°èˆªåƒè€ƒé»å·²è¨­å®šï¼è«‹ç§»å‹•å¾Œè§€å¯Ÿå·®ç•°å’Œæ–¹å‘ã€‚');
            updateNavigation(); 
        }

        // é é¢å•Ÿå‹•æµç¨‹ï¼šå…ˆé¡¯ç¤º Modal
        function initialSetup() {
             if (!navigator.geolocation) {
                permissionModal.classList.add('hidden');
                showMessage('error', 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Geolocation APIã€‚');
                return;
            }
            permissionModal.classList.remove('hidden');
        }

        // è¨»å†Šäº‹ä»¶ç›£è½å™¨
        modalStartButton.addEventListener('click', () => {
            permissionModal.classList.add('hidden');
            startGeolocation();
        });

        startButton.addEventListener('click', startGeolocation);
        stopButton.addEventListener('click', stopGeolocation);
        calibrateButton.addEventListener('click', calibrateGroundAltitude);
        markButton.addEventListener('click', markReferenceLocation);
        
        // é é¢è¼‰å…¥æ™‚ï¼ŒåŸ·è¡Œåˆå§‹è¨­å®š
        window.onload = initialSetup;

    </script>
</body>
</html>

